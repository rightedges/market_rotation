{% extends "base.html" %}

{% block content %}
<div class="header">
    <h1>Market Rotation Analysis</h1>
    <a href="{{ url_for('portfolio.view', id=portfolio.id) }}" class="btn btn-secondary">Back to Portfolio</a>
</div>

<div class="settings-card">
    <div class="settings-header">
        <h2>Strategy Settings</h2>
        <a href="{{ url_for('rotation.analysis', id=portfolio.id, relaxed='true' if not relaxed else 'false', period=period, benchmark=benchmark_ticker, benchmark_weight=benchmark_weight_input, trend_weight=trend_weight, rel_weight=rel_weight) }}"
            class="toggle-switch">
            <span class="badge badge-pill {{ 'badge-success' if relaxed else 'badge-secondary' }}"
                style="background-color: {{ '#d1fae5' if relaxed else '#e2e8f0' }}; color: {{ '#065f46' if relaxed else '#64748b' }};">
                {{ 'Relaxed Mode' if relaxed else 'Strict Mode' }}
            </span>
            <span style="font-size: 0.8rem; color: var(--text-muted);">
                {{ '(All weights adjustable)' if relaxed else '(Benchmark fixed)' }}
            </span>
        </a>
    </div>

    <div class="settings-grid">
        <!-- Benchmark Selection -->
        <div class="control-group">
            <label>Benchmark Asset</label>
            <div class="dropdown" style="width: 100%;">
                <button class="btn btn-secondary dropdown-toggle" type="button" id="benchmarkDropdown"
                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
                    style="width: 100%; justify-content: space-between;">
                    {{ benchmark_ticker }}
                    <span style="margin-left: 0.5rem;">▼</span>
                </button>
                <div class="dropdown-menu" aria-labelledby="benchmarkDropdown" style="width: 100%;">
                    {% for h in available_benchmarks %}
                    <a class="dropdown-item"
                        href="{{ url_for('rotation.analysis', id=portfolio.id, relaxed='true' if relaxed else 'false', period=period, benchmark=h, benchmark_weight=benchmark_weight_input, trend_weight=trend_weight, rel_weight=rel_weight) }}">
                        {{ h }}
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Benchmark Weight -->
        <div class="control-group">
            <label>Benchmark Allocation</label>
            <div style="display: flex; gap: 0.25rem;">
                <form action="{{ url_for('rotation.analysis', id=portfolio.id) }}" method="get" class="input-group">
                    <input type="hidden" name="period" value="{{ period }}">
                    <input type="hidden" name="relaxed" value="{{ 'true' if relaxed else 'false' }}">
                    <input type="hidden" name="benchmark" value="{{ benchmark_ticker }}">
                    <input type="hidden" name="trend_weight" value="{{ trend_weight }}">
                    <input type="hidden" name="rel_weight" value="{{ rel_weight }}">

                    <input type="number" name="benchmark_weight"
                        value="{{ benchmark_weight_input or current_bench_weight }}" min="0" max="100" step="1"
                        class="form-control" style="width: 80px;">
                    <button type="submit" class="btn btn-secondary">Set %</button>
                </form>
                {% if portfolio.analysis_benchmark_weight is not none %}
                <a href="{{ url_for('rotation.analysis', id=portfolio.id, period=period, relaxed='true' if relaxed else 'false', benchmark=benchmark_ticker, trend_weight=trend_weight, rel_weight=rel_weight, reset_benchmark_weight='true') }}"
                    class="btn btn-outline-secondary" title="Clear manual allocation"
                    style="padding: 0 0.75rem; display: flex; align-items: center; border: 1px solid #cbd5e1; color: #64748b;">✕</a>
                {% endif %}
            </div>
        </div>

        <!-- Strategy Weights -->
        <div class="control-group">
            <label>Strategy Weights</label>
            <form action="{{ url_for('rotation.analysis', id=portfolio.id) }}" method="get" class="input-group"
                style="gap: 0.5rem;">
                <input type="hidden" name="period" value="{{ period }}">
                <input type="hidden" name="relaxed" value="{{ 'true' if relaxed else 'false' }}">
                <input type="hidden" name="benchmark" value="{{ benchmark_ticker }}">
                <input type="hidden" name="benchmark_weight"
                    value="{{ benchmark_weight_input or current_bench_weight }}">

                <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                    <label style="font-size: 0.7rem; margin: 0;">Trend</label>
                    <input type="number" name="trend_weight" value="{{ trend_weight }}" min="0" max="50" step="1"
                        class="form-control" style="width: 60px;" title="Trend Weight %">
                </div>

                <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                    <label style="font-size: 0.7rem; margin: 0;">Rel Str</label>
                    <input type="number" name="rel_weight" value="{{ rel_weight }}" min="0" max="50" step="1"
                        class="form-control" style="width: 60px;" title="Relative Strength Weight %">
                </div>

                <div style="display: flex; align-items: flex-end;">
                    <button type="submit" class="btn btn-secondary">Set</button>
                </div>
            </form>
        </div>

        <!-- Backtest Period -->
        <div class="control-group">
            <label>Backtest History</label>
            <div class="segmented-control">
                {% for p in ['5y', '10y', '15y', '20y'] %}
                <a href="{{ url_for('rotation.analysis', id=portfolio.id, relaxed='true' if relaxed else 'false', period=p, benchmark=benchmark_ticker, benchmark_weight=benchmark_weight_input, trend_weight=trend_weight, rel_weight=rel_weight) }}"
                    class="btn {{ 'active' if period == p else '' }}">
                    {{ p }}
                </a>
                {% endfor %}
            </div>
        </div>
    </div>

    <div
        style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color); font-size: 0.875rem; color: var(--text-muted); display: flex; justify-content: space-between;">
        <span>Latest Data: {{ latest_date }}</span>
    </div>
</div>

<form action="{{ url_for('rotation.apply', id=portfolio.id) }}" method="POST">
    <div class="table-container">
        <table class="holdings-table">
            <thead>
                <tr>
                    <th>Ticker</th>
                    <th>Price</th>
                    <th>Trend</th>
                    <th>3M Ret</th>
                    <th>Rel Perf</th>
                    <th>Target Weight</th>
                </tr>
            </thead>
            <tbody>
                {% for item in analysis_data %}
                <tr>
                    <td><strong>{{ item.symbol }}</strong></td>
                    <td>${{ "%.2f"|format(item.current_price) }}</td>
                    <td>
                        <span
                            class="badge badge-pill {{ 'trend-uptrend' if item.trend == 'Uptrend' else 'trend-downtrend' }}">
                            {{ item.trend }}
                        </span>
                    </td>
                    <td>{{ item.ret_3m }}</td>
                    <td>
                        <span
                            class="badge badge-pill {{ 'perf-out' if item.rel_signal == 'Outperform' else 'perf-under' if item.rel_signal == 'Underperform' else 'perf-bench' }}">
                            {{ item.rel_signal }}
                        </span>
                    </td>
                    <td>
                        <strong class="text-blue">{{ item.suggested_weight }}</strong>
                        <input type="hidden" name="weight_{{ item.symbol }}" value="{{ item.suggested_raw }}">
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="form-actions" style="margin-top: 2rem; text-align: right;">
        <button type="submit" class="btn btn-primary">Apply Suggested Targets</button>
    </div>
</form>

<div class="dashboard-grid" style="margin-top: 2rem;">
    <div class="chart-section" style="width: 100%; max-width: 800px; margin: 0 auto 5rem auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <div>
                <h3 style="margin-bottom: 0.25rem;">Backtest Performance ({{ period }})</h3>
                <small style="color: var(--text-muted);">{{ start_date }} to {{ end_date }}</small>
            </div>
        </div>
        <div class="metrics-row" style="display: flex; gap: 2rem; margin-bottom: 1rem;">
            <div class="metric">
                <span class="label">Total Return</span>
                <span class="value">{{ metrics.total_return }}</span>
            </div>
            <div class="metric">
                <span class="label">CAGR</span>
                <span class="value">{{ metrics.cagr }}</span>
            </div>
            <div class="metric">
                <span class="label">Max Drawdown</span>
                <span class="value">{{ metrics.max_drawdown }}</span>
            </div>
        </div>
        <div style="position: relative; height: 400px; width: 100%;">
            <canvas id="backtestChart"></canvas>
        </div>
    </div>
</div>

<div class="card" style="margin-top: 2rem;">
    <div class="card-header">
        <h2>Historical Rotations</h2>
    </div>
    <div class="card-body">
        <div class="table-container" style="max-height: 300px; overflow-y: auto;">
            <table class="holdings-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Portfolio Value</th>
                        {% for ticker in rotation_tickers %}
                        <th>{{ ticker }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in rotation_data %}
                    <tr>
                        <td>{{ row.date }}</td>
                        <td>${{ "{:,.2f}".format(row.value) }}</td>
                        {% for ticker in rotation_tickers %}
                        <td>{{ "%.1f%%"|format(row[ticker] * 100) }}</td>
                        {% endfor %}
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="{{ rotation_tickers|length + 1 }}" style="text-align: center;">No historical data
                            available.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="card" style="margin-top: 2rem;">
    <div class="card-header">
        <h2>Strategy Details</h2>
    </div>
    <div class="card-body">
        <p>The Market Rotation Strategy dynamically adjusts portfolio weights based on momentum and relative strength.
        </p>

        <h3>Rules</h3>
        <ul>
            <li><strong>Trend Filter:</strong> If a stock's price is above its 50-day Moving Average, it is in an
                Uptrend (+{{ trend_weight }}% weight). Otherwise, it is in a Downtrend (-{{ trend_weight }}% weight).
            </li>
            <li><strong>Relative Strength:</strong> If a stock's 3-month return is higher than the benchmark ({{
                benchmark_ticker }}), it
                is Outperforming (+{{ rel_weight }}% weight). Otherwise, it is Underperforming (-{{ rel_weight }}%
                weight).</li>
            <li><strong>Strict Mode:</strong> The benchmark ({{ benchmark_ticker }}) weight is fixed. Only other
                holdings are adjusted.
            </li>
            <li><strong>Relaxed Mode:</strong> All holdings, including the benchmark, are adjusted based on their
                signals.</li>
            <li><strong>Benchmark Allocation:</strong> You can manually set the benchmark's starting weight (e.g. 0%).
                Click the <strong>"Clear" (✕)</strong> button to reset it to <strong>Equal Weight</strong>.
                Clearing is recommended for <em>Relaxed Mode</em> so the benchmark starts on equal footing with other
                assets.</li>
        </ul>

        <p><em>Note: Weights are normalized to sum to 100% and rounded to the nearest 5% for easier execution.</em></p>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx = document.getElementById('backtestChart');
    const chartData = JSON.parse('{{ chart_data | safe }}');

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartData.labels,
            datasets: [
                {
                    label: 'Portfolio Strategy',
                    data: chartData.values,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: true,
                    tension: 0.1
                },
                {
                    label: `Benchmark (${chartData.benchmark_ticker || 'VOO'})`,
                    data: chartData.benchmark_values,
                    borderColor: '#9ca3af',
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(context.parsed.y);
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    ticks: {
                        callback: function (value, index, values) {
                            return '$' + value;
                        }
                    }
                }
            }
        }
    });

    // Custom Dropdown Logic
    document.addEventListener('DOMContentLoaded', function () {
        const dropdowns = document.querySelectorAll('.dropdown');

        dropdowns.forEach(dropdown => {
            const toggle = dropdown.querySelector('.dropdown-toggle');
            const menu = dropdown.querySelector('.dropdown-menu');

            if (toggle && menu) {
                toggle.addEventListener('click', function (e) {
                    e.stopPropagation();
                    menu.classList.toggle('show');
                });
            }
        });

        // Close dropdowns when clicking outside
        document.addEventListener('click', function (e) {
            dropdowns.forEach(dropdown => {
                const menu = dropdown.querySelector('.dropdown-menu');
                if (menu && menu.classList.contains('show')) {
                    menu.classList.remove('show');
                }
            });
        });
    });
</script>
{% endblock %}